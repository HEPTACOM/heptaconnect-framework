image: heptacom/heptaconnect-pipeline:php74-6.0.2

definitions:
    services:
        mysql:
            image: mysql:5.7
            variables:
                MYSQL_DATABASE: 'pipelines'
                MYSQL_ROOT_PASSWORD: 'let_me_in'
    steps:
        -   step: &default-step
                caches:
                    - composer
                after-script:
                    - cp -a .build test-results
                    - find test-results -type f -name '*.xml' -exec sed -i .bak -e "s|`pwd`/||" {} +
                    - 'test ${BITBUCKET_EXIT_CODE} -eq 0 || composer config --list'
        -   step: &github-keyword-gate-step
                <<: *default-step
                name: Github Keyword Gate
                script:
                    - 'test $(git --no-pager log --full-history "--grep=${GITHUB_GREP_DENY_PATTERN}" | wc -l) -eq 0'
                    - 'test $(git --no-pager log --full-history -S "${GITHUB_GREP_DENY_PATTERN}" --pickaxe-all --pickaxe-regex --oneline | wc -l) -eq 0'
                after-script:
                    - 'test ${BITBUCKET_EXIT_CODE} -eq 0 || git --no-pager log --full-history "--grep=${GITHUB_GREP_DENY_PATTERN}"'
                    - 'test ${BITBUCKET_EXIT_CODE} -eq 0 || git --no-pager log --full-history -S "${GITHUB_GREP_DENY_PATTERN}" --pickaxe-all --pickaxe-regex --oneline'
        -   step: &github-mirror-branch
                <<: *default-step
                name: Mirror to Github
                script:
                    - git fetch --unshallow origin
                    - git remote add github "git@github.com:HEPTACOM/${BITBUCKET_REPO_SLUG}.git"
                    - git push --force github ${BITBUCKET_BRANCH}
                    - COMMIT=${BITBUCKET_COMMIT} BRANCH=${BITBUCKET_BRANCH} make -e publish-packages
        -   step: &github-mirror-tag
                <<: *default-step
                name: Mirror tags to Github
                script:
                    - git remote add github "git@github.com:HEPTACOM/${BITBUCKET_REPO_SLUG}.git"
                    - git push --force github tag "${BITBUCKET_TAG}"
                    - git tag -d "${BITBUCKET_TAG}"
                    - COMMIT=${BITBUCKET_COMMIT} TAG=${BITBUCKET_TAG} make -e publish-packages
        -   step: &composer-high-install
                <<: *default-step
                name: Install (High dependencies)
                artifacts:
                    - .build/**
                    - vendor/**
                    - composer.lock
                script:
                    - COMPOSER_EXTRA_ARGS=-vvv make -e vendor
        -   step: &composer-low-install
                <<: *default-step
                name: Install (Low dependencies)
                artifacts:
                    - .build/**
                    - vendor/**
                    - composer.lock
                script:
                    - composer update --prefer-lowest --prefer-stable
                    - COMPOSER_EXTRA_ARGS=-vvv make -e vendor
        -   step: &composer-install-core
                <<: *default-step
                name: Install Core
                script:
                    - composer install -d src/Core
        -   step: &composer-install-dataset-base
                <<: *default-step
                name: Install Dataset Base
                script:
                    - composer install -d src/DatasetBase
        -   step: &composer-install-portal-base
                <<: *default-step
                name: Install Portal Base
                script:
                    - composer install -d src/PortalBase
        -   step: &composer-install-storage-base
                <<: *default-step
                name: Install Storage Base
                script:
                    - composer install -d src/StorageBase
        -   step: &test-unit
                <<: *default-step
                name: Unit tests
                script:
                    - COMPOSER_EXTRA_ARGS=-vvv make -e test
        -   step: &test-coverage
                <<: *default-step
                name: Unit test coverage
                script:
                    - COMPOSER_EXTRA_ARGS=-vvv make -e coverage
        -   step: &test-code-style
                <<: *default-step
                name: Code style and static code analysis
                script:
                    - COMPOSER_EXTRA_ARGS=-vvv make -e cs
        -   step: &test-infection
                <<: *default-step
                name: Unit test infection detection
                script:
                    - COMPOSER_EXTRA_ARGS=-vvv make -e infection

pipelines:
    branches:
        master:
            -   step: *github-keyword-gate-step
            -   step: *github-mirror-branch
            -   parallel:
                    -   step: *composer-install-core
                    -   step: *composer-install-dataset-base
                    -   step: *composer-install-portal-base
                    -   step: *composer-install-storage-base
            -   step: *composer-high-install
            -   parallel:
                    -   step: *test-unit
                    -   step: *test-coverage
                    -   step: *test-code-style
            -   step: *composer-low-install
            -   parallel:
                    -   step: *test-unit
                    -   step: *test-coverage
                    -   step: *test-code-style

    tags:
        '*':
            -   parallel:
                    -   step: *composer-install-core
                    -   step: *composer-install-dataset-base
                    -   step: *composer-install-portal-base
                    -   step: *composer-install-storage-base
            -   step: *composer-low-install
            -   step: *composer-high-install
            -   step: *github-keyword-gate-step
            -   step: *github-mirror-tag

    default:
        -   parallel:
                -   step: *composer-install-core
                -   step: *composer-install-dataset-base
                -   step: *composer-install-portal-base
                -   step: *composer-install-storage-base
        -   step: *composer-high-install
        -   parallel:
                -   step: *test-unit
                -   step: *test-coverage
                -   step: *test-code-style
        -   step: *composer-low-install
        -   parallel:
                -   step: *test-unit
                -   step: *test-coverage
                -   step: *test-code-style
